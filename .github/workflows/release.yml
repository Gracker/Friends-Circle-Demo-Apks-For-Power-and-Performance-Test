name: Manual Release with Signing

on:
  workflow_dispatch:
    inputs:
      version_name:
        description: 'ç‰ˆæœ¬åç§° (ä¾‹å¦‚: v1.2.0)'
        required: true
        default: 'v1.0.0'
      release_notes:
        description: 'å‘å¸ƒè¯´æ˜'
        required: false
        default: 'æ–°ç‰ˆæœ¬å‘å¸ƒ'

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'

    - name: Validate Gradle wrapper
      uses: gradle/wrapper-validation-action@v1

    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
      
    - name: Make Gradle wrapper executable
      run: chmod +x ./gradlew
      
    - name: Decode Keystore (if available)
      if: ${{ secrets.KEYSTORE_BASE64 != '' }}
      uses: timheuer/base64-to-file@v1
      with:
        fileName: 'release.keystore'
        encodedString: ${{ secrets.KEYSTORE_BASE64 }}
        
    - name: Build Release APKs
      env:
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        if [ -f "release.keystore" ]; then
          echo "ä½¿ç”¨æä¾›çš„ç­¾åå¯†é’¥æ„å»ºReleaseç‰ˆæœ¬..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ ç­¾åé…ç½®ï¼Œæš‚æ—¶å…ˆæ„å»ºæ— ç­¾åç‰ˆæœ¬
          ./gradlew assembleRelease --parallel
        else
          echo "æœªæä¾›ç­¾åå¯†é’¥ï¼Œæ„å»ºæ— ç­¾åReleaseç‰ˆæœ¬..."
          ./gradlew assembleRelease --parallel
        fi
      
    - name: Prepare Release Files
      run: |
        mkdir -p release-files
        BUILD_TIME=$(date +'%Y%m%d-%H%M%S')
        
        # å¤åˆ¶ç”Ÿæˆçš„APKæ–‡ä»¶
        find . -name "*-release*.apk" -type f | while read apk; do
          filename=$(basename "$apk")
          module_name=$(echo "$filename" | sed 's/-release.*//g')
          cp "$apk" "release-files/${module_name}-${{ github.event.inputs.version_name }}.apk"
        done
        
        # å¤åˆ¶ç°æœ‰çš„releaseæ–‡ä»¶å¤¹ä¸­çš„APKï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
        if [ -d "apk-released" ]; then
          cp apk-released/*.apk release-files/ 2>/dev/null || true
        fi
        
        echo "å‡†å¤‡å‘å¸ƒçš„æ–‡ä»¶:"
        ls -la release-files/
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.version_name }}
        name: "æ­£å¼å‘å¸ƒ ${{ github.event.inputs.version_name }}"
        body: |
          ğŸ‰ **æ­£å¼ç‰ˆæœ¬å‘å¸ƒ**
          
          ğŸ“± **ç‰ˆæœ¬**: ${{ github.event.inputs.version_name }}
          ğŸ“… **å‘å¸ƒæ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S')
          ğŸ”— **æäº¤**: $(git rev-parse --short HEAD)
          
          ## ğŸ“ å‘å¸ƒè¯´æ˜
          ${{ github.event.inputs.release_notes }}
          
          ## ğŸ“¦ åŒ…å«çš„åº”ç”¨
          
          ### ğŸš€ ä¸»è¦æ¨¡å—
          - **HighPerformanceFriendsCircle** - é«˜æ€§èƒ½æœ‹å‹åœˆä¸»åº”ç”¨
          - **WeChatFriendForPerformance** - æ€§èƒ½æµ‹è¯•æ¨¡å—
          - **WeChatFriendForPower** - åŠŸè€—æµ‹è¯•æ¨¡å—  
          - **WeChatFriendForWebView** - WebViewæ€§èƒ½å¯¹æ¯”æ¨¡å—
          
          ## ğŸ”§ å®‰è£…è¯´æ˜
          1. ä¸‹è½½å¯¹åº”çš„APKæ–‡ä»¶
          2. åœ¨Androidè®¾å¤‡ä¸Šå¯ç”¨"å…è®¸å®‰è£…æœªçŸ¥æ¥æºåº”ç”¨"
          3. ç›´æ¥å®‰è£…APKæ–‡ä»¶
          
          ## ğŸ“Š æ€§èƒ½ç‰¹æ€§
          - é«˜æ€§èƒ½åˆ—è¡¨æ»‘åŠ¨ä¼˜åŒ–
          - å¤šç§è´Ÿè½½æµ‹è¯•æ¨¡å¼
          - åŠŸè€—ç›‘æ§å’Œåˆ†æ
          - WebViewä¸åŸç”Ÿæ€§èƒ½å¯¹æ¯”
          
          ## ğŸ› é—®é¢˜åé¦ˆ
          å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨GitHub Issuesä¸­åé¦ˆ
          
          ---
          â­ æ„Ÿè°¢ä½¿ç”¨ï¼å¦‚æœè§‰å¾—æœ‰ç”¨è¯·ç»™ä¸ªStar
        files: release-files/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}